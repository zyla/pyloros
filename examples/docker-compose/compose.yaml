# Docker Compose example: run containers with network access routed through
# the pyloros proxy.
#
# Architecture:
#
#   external network (bridge) ─── proxy ─── Internet
#                                   │
#   internal network (--internal) ── sandbox
#
# The sandbox container has NO direct internet access; all traffic must go
# through the proxy's allowlist rules.
#
# Prerequisites:
#   1. Generate a CA:  pyloros generate-ca --out ./certs/
#      (or: cargo run -- generate-ca --out ./certs/)
#
# Usage:
#   # Set path to CA directory (absolute path required)
#   export CA_DIR="$(pwd)/certs"
#
#   # Start services (uses published Docker image by default)
#   docker compose -f examples/docker-compose/compose.yaml up -d
#
#   # Or use a local image:
#   export PROXY_IMAGE="my-local-image:latest"
#   docker compose -f examples/docker-compose/compose.yaml up -d
#
#   # Run commands in the sandbox
#   docker compose -f examples/docker-compose/compose.yaml exec sandbox sh
#
#   # Tear down
#   docker compose -f examples/docker-compose/compose.yaml down

services:
  proxy:
    image: ${PROXY_IMAGE:-ghcr.io/zyla/pyloros:latest}
    volumes:
      - ./config.toml:/etc/pyloros/config.toml:ro
      - ${CA_DIR:?Set CA_DIR to absolute path of CA certificate directory}/ca.crt:/etc/pyloros/ca.crt:ro
      - ${CA_DIR:?Set CA_DIR to absolute path of CA certificate directory}/ca.key:/etc/pyloros/ca.key:ro
    command:
      - run
      - --config
      - /etc/pyloros/config.toml
      - --ca-cert
      - /etc/pyloros/ca.crt
      - --ca-key
      - /etc/pyloros/ca.key
      - --bind
      - "0.0.0.0:8080"
    networks:
      - external
      - internal
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "8080"]
      interval: 2s
      timeout: 3s
      retries: 15
      start_period: 5s

  sandbox:
    image: ${SANDBOX_IMAGE:-alpine:latest}
    command: sleep infinity
    depends_on:
      proxy:
        condition: service_healthy
    environment:
      - HTTP_PROXY=http://proxy:8080
      - HTTPS_PROXY=http://proxy:8080
      - http_proxy=http://proxy:8080
      - https_proxy=http://proxy:8080
      - no_proxy=
      - SSL_CERT_FILE=/etc/pyloros/ca.crt
      - CURL_CA_BUNDLE=/etc/pyloros/ca.crt
      - NODE_EXTRA_CA_CERTS=/etc/pyloros/ca.crt
      - GIT_SSL_CAINFO=/etc/pyloros/ca.crt
      - REQUESTS_CA_BUNDLE=/etc/pyloros/ca.crt
    volumes:
      - ${CA_DIR:?Set CA_DIR to absolute path of CA certificate directory}/ca.crt:/etc/pyloros/ca.crt:ro
    networks:
      - internal

networks:
  external:
    driver: bridge
  internal:
    internal: true
